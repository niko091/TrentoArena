<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrentoArena - Profile</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/game_popup.css">
    <link rel="stylesheet" href="/css/game_popup_participants.css">
    <link rel="stylesheet" href="/css/popup_shared.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="/js/popup_manager.js"></script>
    <script src="/js/i18n.js"></script>
</head>

<body>
    <div id="navbar"></div>
    <script>
        // Navbar inline loader
        fetch("/utility/navbar.html").then(r => r.text()).then(d => {
            document.getElementById("navbar").innerHTML = d;
            if (window.i18n) window.i18n.translatePage();
        });
    </script>

    <div class="container mt-5">
        <div class="d-flex flex-column flex-lg-row align-items-start justify-content-center p-4 gap-5">

            <div class="flex-shrink-0 text-center">
                <div style="position: relative; display: inline-block;">
                    <img id="profilePic" src="/images/utenteDefault.png" alt="Profile Picture" class="rounded-circle"
                        style="width: 250px; height: 250px; object-fit: cover; border: 5px solid #fff; box-shadow: 0 0 15px rgba(0,0,0,0.1);">

                    <div id="editControls" style="display: none;">
                        <label for="fileInput" class="btn btn-primary rounded-circle shadow"
                            style="position: absolute; bottom: 10px; right: 10px; width: 40px; height: 40px; padding: 4px 0; font-size: 1.2rem; cursor: pointer;">+</label>
                        <button id="removePicBtn" class="btn btn-danger rounded-circle shadow"
                            style="position: absolute; bottom: 10px; left: 10px; width: 40px; height: 40px; padding: 4px 0; font-size: 1.2rem; display: none;">x</button>
                        <input type="file" id="fileInput" style="display: none;" accept="image/*">
                    </div>
                </div>

                <h1 id="username" class="fw-bold mt-4 mb-2 display-6" data-i18n="common.loading">Loading...</h1>
                <p id="email" class="text-muted mb-4" style="display: none;" data-i18n="common.loading">Loading...</p>

                <div id="publicActions" class="justify-content-center gap-2 mt-3" style="display: none;">
                    <button id="addFriendBtn" class="btn btn-primary" data-i18n="profile.add_friend">Add Friend</button>
                    <button id="reportUserBtn" class="btn btn-outline-danger btn-sm"
                        data-i18n="profile.report_user">Report User</button>
                </div>

                <div id="privateActions" class="mt-3" style="display: none;">
                    <a href="/auth/logout" class="btn btn-outline-danger btn-lg px-5 w-100"
                        data-i18n="navbar.logout">Logout</a>
                </div>
            </div>

            <div class="flex-grow-1">
                <div id="eloStatsContainer" class="mb-5" style="display: none;">
                    <h5 class="fw-bold mb-3" data-i18n="profile.elo_stats">ELO Statistics</h5>
                    <select id="eloSportSelect" class="form-select mb-3" aria-label="Select Sport for ELO">
                        <option selected disabled data-i18n="profile.select_sport">Select a sport...</option>
                    </select>
                    <div id="eloDisplay" class="text-center p-3 border rounded"
                        style="min-height: 400px; display: flex; align-items: center; justify-content: center;">
                        <span class="text-muted" id="eloPlaceholder" data-i18n="profile.elo_placeholder">Select a sport
                            to see your rating history</span>
                        <canvas id="eloChart" style="display: none;"></canvas>
                    </div>
                </div>
            </div>

            <div class="flex-shrink-0" style="width: 300px;">
                <h4 class="fw-bold mb-3 border-bottom pb-2" data-i18n="profile.friends">Friends</h4>
                <div id="friendsList" class="d-flex flex-wrap gap-2 justify-content-start mb-5">
                    <span class="text-muted" data-i18n="common.loading">Loading friends...</span>
                </div>

                <h4 class="fw-bold mb-3 border-bottom pb-2 mt-5" data-i18n="profile.calendar">Calendario partite</h4>
                <div class="card shadow-sm border-0">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between mb-3 text-muted fw-bold small text-center px-1">
                            <span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span><span>S</span>
                        </div>
                        <div id="dotsContainer"
                            style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; justify-items: center; align-items: center;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-5">
            <h2 class="fw-bold mb-4 border-bottom pb-2" data-i18n="profile.upcoming_games">Upcoming Games</h2>
            <div id="myGamesList" class="row g-3">
                <div class="col-12"><span class="text-muted" data-i18n="common.loading">Loading games...</span></div>
            </div>
        </div>

        <div class="mt-5 mb-5">
            <h2 class="fw-bold mb-4 border-bottom pb-2" data-i18n="profile.past_games">Past Games</h2>
            <div id="myPastGamesList" class="row g-3">
                <div class="col-12"><span class="text-muted" data-i18n="common.loading">Loading past games...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n="profile.report_modal_title">Report User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control" id="reportMotivation" rows="3" placeholder="Motivazione..."
                        data-i18n="profile.report_reason"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="submitReportBtn"
                        data-i18n="profile.report_submit">Invia Report</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="/js/game_popup.js"></script>
    <script src="/js/profile/profile_api.js"></script>
    <script src="/js/profile/profile_ui.js"></script>
    <script src="/js/profile/profile.js" defer></script>
    <script src="/js/notification.js"></script>

    <script>
        window.addEventListener('load', function () {
            setTimeout(() => {
                const title = document.getElementById('username');
                if (title && title.textContent === 'Loading...') {
                    console.error("TIMEOUT: Controlla la console per errori 404.");
                }
            }, 3000);
        });
    </script>

</html>