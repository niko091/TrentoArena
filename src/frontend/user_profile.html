<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrentoArena - User Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/game_popup.css">
    <link rel="stylesheet" href="/css/game_popup_participants.css">
    <link rel="stylesheet" href="/css/popup_shared.css">
    <script src="/js/popup_manager.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
    <div id="navbar"></div>

    <script>
        fetch("/utility/navbar.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("navbar").innerHTML = data;
            });
    </script>

    <div class="container mt-5">
        <div class="d-flex flex-column flex-lg-row align-items-start justify-content-center p-4 gap-5">
            <!-- Left Column: Profile Picture -->
            <div class="flex-shrink-0 text-center">
                <div style="position: relative; display: inline-block;">
                    <img id="profilePic" src="/images/utenteDefault.png" alt="Profile Picture" class="rounded-circle"
                        style="width: 250px; height: 250px; object-fit: cover; border: 5px solid #fff; box-shadow: 0 0 15px rgba(0,0,0,0.1);">
                </div>
                <h1 id="username" class="fw-bold mt-4 mb-2 display-6">Loading...</h1>
                <div class="d-flex justify-content-center gap-2 mt-2">
                    <button id="addFriendBtn" class="btn btn-primary" style="display: none;">Add Friend</button>
                    <button id="reportUserBtn" class="btn btn-outline-danger btn-sm" style="display: none;">Report
                        User</button>
                </div>
            </div>

            <!-- Middle Column: User Details -->
            <div class="flex-grow-1">

                <!-- ELO Statistics -->
                <div id="eloStatsContainer" class="mb-5" style="display: none;">
                    <h5 class="fw-bold mb-3">ELO</h5>
                    <select id="eloSportSelect" class="form-select mb-3" aria-label="Select Sport for ELO">
                        <option selected disabled>Select a sport...</option>
                    </select>
                    <div id="eloDisplay" class="text-center p-3 border rounded bg-light"
                        style="min-height: 400px; display: flex; align-items: center; justify-content: center;">
                        <span class="text-muted" id="eloPlaceholder">Select a sport to see rating history</span>
                        <canvas id="eloChart" style="display: none; width: 100%; height: 100%;"></canvas>
                    </div>
                </div>

            </div>

            <!-- Right Column: Friends List -->
            <div class="flex-shrink-0" style="width: 300px;">
                <h4 class="fw-bold mb-3 border-bottom pb-2">Friends</h4>
                <div id="friendsList" class="d-flex flex-wrap gap-2 justify-content-start">
                    <!-- Friend avatars will be injected here -->
                    <span class="text-muted">Loading friends...</span>
                </div>
            </div>
        </div>

        <!-- My Games Section -->
        <div class="mt-5">
            <h2 class="fw-bold mb-4 border-bottom pb-2">Upcoming Games</h2>
            <div id="myGamesList" class="row g-3">
                <!-- Games will be injected here -->
                <div class="col-12">
                    <span class="text-muted">Loading games...</span>
                </div>
            </div>
        </div>

        <!-- My Past Games Section -->
        <div class="mt-5 mb-5">
            <h2 class="fw-bold mb-4 border-bottom pb-2">Past Games</h2>
            <div id="myPastGamesList" class="row g-3">
                <!-- Past Games will be injected here -->
                <div class="col-12">
                    <span class="text-muted">Loading past games...</span>
                </div>

            </div>
        </div>
    </div>
    </div>

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Report User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reportForm">
                        <div class="mb-3">
                            <label for="reportMotivation" class="form-label">Motivation</label>
                            <textarea class="form-control" id="reportMotivation" rows="3" required
                                placeholder="Describe the reason for reporting..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="submitReportBtn">Submit Report</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/game_popup.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const pathParts = window.location.pathname.split('/');
            const username = pathParts[pathParts.length - 1];

            if (!username) {
                alert("No username specified");
                return;
            }

            let currentSessionUser = null;

            // Check if user is viewing their own profile
            fetch('/auth/current_user')
                .then(response => response.json())
                .then(currentUser => {
                    currentSessionUser = currentUser;
                    if (currentUser && currentUser.username === username) {
                        window.location.href = '/profile';
                    } else {
                        loadPublicProfile(username, currentUser);
                    }
                })
                .catch(error => {
                    console.error('Auth check skipped or failed:', error);
                    loadPublicProfile(username, null);
                });

            // Global Report Logic
            const submitReportBtn = document.getElementById('submitReportBtn');
            submitReportBtn.addEventListener('click', async () => {
                if (!currentSessionUser) {
                    alert('You must be logged in to report a user.');
                    return;
                }

                const modalElement = document.getElementById('reportModal');
                const reportedId = modalElement.dataset.reportedId;
                const motivation = document.getElementById('reportMotivation').value;

                if (!reportedId) {
                    alert('Error: No user selected.');
                    return;
                }
                if (!motivation.trim()) {
                    alert('Please provide a motivation.');
                    return;
                }

                try {
                    const res = await fetch('/api/reports', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            reporterId: currentSessionUser._id,
                            reportedId: reportedId,
                            motivation: motivation
                        })
                    });

                    if (res.ok) {
                        alert('Report submitted successfully.');
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        modal.hide();
                        document.getElementById('reportForm').reset();
                    } else {
                        const data = await res.json();
                        alert('Error: ' + data.message);
                    }
                } catch (err) {
                    console.error('Error submitting report:', err);
                    alert('Failed to submit report.');
                }
            });
        });

        function loadPublicProfile(username, currentUser) {
            fetch(`/api/users/username/${username}`)
                .then(response => {
                    if (!response.ok) throw new Error('User not found');
                    return response.json();
                })
                .then(async (publicUser) => {
                    // Fetch full details using ID to get ELO and populated friends for sure
                    try {
                        const response = await fetch(`/api/users/${publicUser._id}`);
                        if (!response.ok) throw new Error('Failed to fetch user details');
                        const user = await response.json();

                        document.getElementById('username').textContent = user.username;

                        if (user.profilePicture) {
                            document.getElementById('profilePic').src = user.profilePicture;
                        }

                        // Configure Add Friend Button
                        const addFriendBtn = document.getElementById('addFriendBtn');
                        if (currentUser) {
                            addFriendBtn.style.display = 'inline-block';

                            // Check if already friends
                            const isFriend = user.friends && user.friends.some(f => f._id === currentUser._id || f === currentUser._id);
                            // Check if request already sent
                            const hasSentRequest = user.friendRequests && user.friendRequests.some(r => r._id === currentUser._id || r === currentUser._id);

                            if (isFriend) {
                                addFriendBtn.textContent = 'Remove Friend';
                                addFriendBtn.classList.remove('btn-primary');
                                addFriendBtn.classList.add('btn-danger');
                                addFriendBtn.disabled = false;

                                addFriendBtn.onclick = async () => {
                                    if (!confirm('Are you sure you want to remove this friend?')) return;

                                    try {
                                        const res = await fetch(`/api/users/${currentUser._id}/friends/${user._id}`, {
                                            method: 'DELETE'
                                        });

                                        if (res.ok) {
                                            alert('Friend removed.');
                                            window.location.reload();
                                        } else {
                                            const err = await res.json();
                                            alert('Error: ' + err.message);
                                        }
                                    } catch (e) {
                                        console.error('Error removing friend:', e);
                                        alert('Failed to remove friend.');
                                    }
                                };
                            } else if (hasSentRequest) {
                                addFriendBtn.textContent = 'Request Sent';
                                addFriendBtn.classList.remove('btn-primary');
                                addFriendBtn.classList.add('btn-secondary');
                                addFriendBtn.disabled = true;
                            } else {
                                // Check if THEY sent US a request
                                const hasReceivedRequest = currentUser.friendRequests && currentUser.friendRequests.some(r => r._id === user._id || r === user._id || r === user._id.toString());

                                if (hasReceivedRequest) {
                                    addFriendBtn.textContent = 'Accept Request';
                                    addFriendBtn.classList.remove('btn-primary', 'btn-danger', 'btn-secondary');
                                    addFriendBtn.classList.add('btn-success');
                                    addFriendBtn.disabled = false;

                                    addFriendBtn.onclick = async () => {
                                        try {
                                            const res = await fetch(`/api/users/${currentUser._id}/friends/accept`, {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ requesterId: user._id })
                                            });

                                            if (res.ok) {
                                                alert('Friend request accepted!');
                                                window.location.reload();
                                            } else {
                                                const err = await res.json();
                                                alert('Error: ' + err.message);
                                            }
                                        } catch (e) {
                                            console.error('Error accepting request:', e);
                                            alert('Failed to accept friend request.');
                                        }
                                    };
                                } else {
                                    addFriendBtn.textContent = 'Add Friend';
                                    addFriendBtn.classList.add('btn-primary');
                                    addFriendBtn.disabled = false;

                                    addFriendBtn.onclick = async () => {
                                        try {
                                            const res = await fetch(`/api/users/${user._id}/friend-requests`, {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ requesterId: currentUser._id })
                                            });

                                            if (res.ok) {
                                                alert('Friend request sent!');
                                                addFriendBtn.textContent = 'Request Sent';
                                                addFriendBtn.classList.remove('btn-primary');
                                                addFriendBtn.classList.add('btn-secondary');
                                                addFriendBtn.disabled = true;
                                            } else {
                                                const err = await res.json();
                                                alert('Error: ' + err.message);
                                            }
                                        } catch (e) {
                                            console.error('Error sending request:', e);
                                            alert('Failed to send friend request.');
                                        }
                                    };
                                }
                            }
                        }

                        // Configure Report Button
                        const reportBtn = document.getElementById('reportUserBtn');
                        if (currentUser && currentUser._id !== user._id) {
                            reportBtn.style.display = 'inline-block';

                            reportBtn.onclick = () => {
                                const modalElement = document.getElementById('reportModal');
                                modalElement.dataset.reportedId = user._id; // Set ID

                                let modal = bootstrap.Modal.getInstance(modalElement);
                                if (!modal) {
                                    modal = new bootstrap.Modal(modalElement);
                                }
                                modal.show();
                            };
                        }

                        // Render Friends List
                        const friendsListContainer = document.getElementById('friendsList');
                        friendsListContainer.innerHTML = '';

                        if (user.friends && user.friends.length > 0) {
                            user.friends.forEach(friend => {
                                const friendDiv = document.createElement('div');
                                friendDiv.className = 'text-center';
                                friendDiv.style.width = '60px';

                                const img = document.createElement('img');
                                const picPath = friend.profilePicture;
                                const picSrc = picPath ? (picPath.startsWith('http') ? picPath : '/' + picPath) : '/images/utenteDefault.png';
                                img.src = picSrc;
                                img.alt = friend.username;
                                img.className = 'rounded-circle shadow-sm border border-white';
                                img.style.width = '50px';
                                img.style.height = '50px';
                                img.style.objectFit = 'cover';
                                img.title = friend.username;
                                img.style.cursor = 'pointer';

                                const link = document.createElement('a');
                                link.href = `/user/${friend.username}`;
                                link.style.textDecoration = 'none';
                                link.appendChild(img);

                                friendDiv.appendChild(link);
                                friendsListContainer.appendChild(friendDiv);
                            });
                        } else {
                            friendsListContainer.innerHTML = '<span class="text-muted">No friends yet.</span>';
                        }

                        // Render ELO Stats
                        renderEloStats(user);

                        // Load Games
                        loadMyGames(user._id);

                    } catch (e) {
                        console.error("Error loading full profile:", e);
                        alert("Failed to load profile details.");
                    }
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                    document.querySelector('.container').innerHTML = '<div class="alert alert-danger text-center">User not found</div>';
                });
        }

        function renderEloStats(user) {
            if (user.sportsElo && user.sportsElo.length > 0) {
                const eloContainer = document.getElementById('eloStatsContainer');
                const sportSelect = document.getElementById('eloSportSelect');
                const eloDisplay = document.getElementById('eloDisplay');
                const eloPlaceholder = document.getElementById('eloPlaceholder');
                const canvas = document.getElementById('eloChart');
                let chartInstance = null;

                eloContainer.style.display = 'block';

                // Reset select
                sportSelect.innerHTML = '<option selected disabled value="">Select a sport...</option>';

                user.sportsElo.forEach((stat, index) => {
                    const sportName = stat.sport ? stat.sport.name : 'Unknown Sport';
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = sportName;
                    sportSelect.appendChild(option);
                });

                // Handle Change
                sportSelect.addEventListener('change', (e) => {
                    const selectedIndex = sportSelect.value;
                    if (selectedIndex === "") return;

                    const stat = user.sportsElo[selectedIndex];
                    const sportName = stat.sport ? stat.sport.name : 'Unknown Sport';

                    const labels = [];
                    const data = [];

                    if (stat.history && stat.history.length > 0) {
                        const history = stat.history.sort((a, b) => new Date(a.date) - new Date(b.date));
                        history.forEach(h => {
                            const date = new Date(h.date).toLocaleDateString();
                            labels.push(date);
                            data.push(h.elo);
                        });
                    }

                    if (data.length === 0) {
                        labels.push('Start');
                        data.push(stat.elo);
                    }

                    eloPlaceholder.style.display = 'none';
                    canvas.style.display = 'block';

                    if (chartInstance) {
                        chartInstance.destroy();
                    }

                    chartInstance = new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `${sportName} ELO`,
                                data: data,
                                borderColor: 'rgba(255, 159, 64, 1)',
                                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                                tension: 0.3,
                                fill: true,
                                pointRadius: 5,
                                pointHoverRadius: 7
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            return `ELO: ${context.parsed.y}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    suggestedMin: 1000,
                                    suggestedMax: 1400
                                }
                            }
                        }
                    });
                });

                if (user.sportsElo.length > 0) {
                    sportSelect.selectedIndex = 1;
                    sportSelect.dispatchEvent(new Event('change'));
                }
            }
        }

        let cachedGames = {};

        async function loadMyGames(userId) {
            fetchAndRenderGames(userId, false, 'myGamesList', 'No upcoming games found.');
            fetchAndRenderGames(userId, true, 'myPastGamesList', 'No past games found.');
        }

        async function fetchAndRenderGames(userId, isFinished, containerId, emptyMessage) {
            try {
                const response = await fetch(`/api/games?participantId=${userId}&isFinished=${isFinished}`);
                if (!response.ok) throw new Error('Failed to fetch games');
                const games = await response.json();

                games.forEach(g => cachedGames[g._id] = g);

                if (isFinished) {
                    games.sort((a, b) => new Date(b.date) - new Date(a.date));
                } else {
                    games.sort((a, b) => new Date(a.date) - new Date(b.date));
                }

                renderGames(games, containerId, emptyMessage, userId);
            } catch (err) {
                console.error(`Error loading games for ${containerId}:`, err);
                document.getElementById(containerId).innerHTML = '<div class="col-12 text-danger">Failed to load games.</div>';
            }
        }

        function renderGames(games, containerId, emptyMessage, currentUserId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (games.length === 0) {
                container.innerHTML = `<div class="col-12 text-muted">${emptyMessage}</div>`;
                return;
            }

            games.forEach(game => {
                const date = new Date(game.date);
                const dateStr = date.toLocaleDateString();
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const sportName = game.sport ? game.sport.name : 'Unknown Sport';
                const placeName = game.place ? game.place.name : 'Unknown Place';
                const isFinished = game.isFinished;

                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4';

                let cardStyle = '';
                let badgeHtml = '';
                let borderClass = '';

                if (isFinished) {
                    cardStyle = 'opacity: 0.9;';
                    // Determine outcome if userId is provided
                    if (currentUserId && game.participants) {
                        const participant = game.participants.find(p => {
                            const pId = p.user._id || p.user;
                            return pId === currentUserId;
                        });

                        if (participant) {
                            if (participant.winner) {
                                cardStyle += 'background-color: #d1e7dd;';
                                borderClass = 'border-success';
                                badgeHtml = '<span class="badge bg-success me-1">Won üèÜ</span>';
                            } else {
                                cardStyle += 'background-color: #f8d7da;';
                                borderClass = 'border-danger';
                                badgeHtml = '<span class="badge bg-danger me-1">Lost</span>';
                            }
                        }
                    }
                    if (!badgeHtml) badgeHtml = '<span class="badge bg-secondary me-1">Finished</span>';
                } else {
                    badgeHtml = `<span class="badge bg-secondary">${game.participants.length}/${game.maxParticipants}</span>`;
                }

                card.innerHTML = `
                    <div class="card h-100 shadow-sm ${borderClass}" style="cursor: pointer; transition: transform 0.2s; ${cardStyle}" onclick="openGameDetails('${game._id}')">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="card-title fw-bold mb-0 text-primary">${sportName}</h5>
                                <div>
                                    ${badgeHtml}
                                </div>
                            </div>
                            <h6 class="card-subtitle mb-2 text-muted">${placeName}</h6>
                            <p class="card-text mb-2">
                                üìÖ ${dateStr} at ${timeStr}
                             </p>
                             ${game.note ? `<p class="card-text small text-muted text-truncate">üìù ${game.note}</p>` : ''}
                        </div>
                    </div>
                `;

                const innerCard = card.querySelector('.card');
                innerCard.onmouseover = () => innerCard.style.transform = 'translateY(-5px)';
                innerCard.onmouseout = () => innerCard.style.transform = 'translateY(0)';

                container.appendChild(card);
            });
        }

        window.openGameDetails = function (gameId) {
            const game = cachedGames[gameId];
            if (game && window.GameDetailsPopup) {
                window.GameDetailsPopup.show(game);
            } else {
                console.error("Game data or Popup not available");
                if (!window.GameDetailsPopup) alert('Popup not loaded');
            }
        };
    </script>
</body>

</html>