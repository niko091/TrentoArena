<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrentoArena - User Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div id="navbar"></div>

    <script>
        fetch("/utility/navbar.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("navbar").innerHTML = data;
                // Re-attach event listener for game creation if needed (though navbar.html handles it mostly inline now)
            });
    </script>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">Public Profile</h3>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <img id="profilePic" src="/images/utenteDefault.png" alt="Profile Picture"
                                class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;">
                            <h4 id="username" class="card-title mb-0">Loading...</h4>
                            <button id="addFriendBtn" class="btn btn-primary mt-3" style="display: none;">Richiedi
                                amicizia</button>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Friends
                                <span id="friendsCount" class="badge bg-primary rounded-pill">0</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Get username from URL path: /user/:username
            const pathParts = window.location.pathname.split('/');
            const username = pathParts[pathParts.length - 1]; // Last part is username

            if (!username) {
                document.getElementById('username').textContent = 'User not specified';
                return;
            }

            try {
                const response = await fetch(`/api/users/username/${username}`);
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('username').textContent = user.username;
                    document.getElementById('friendsCount').textContent = user.friends ? user.friends.length : 0;
                    if (user.profilePicture) {
                        document.getElementById('profilePic').src = user.profilePicture;
                    }

                    // Fetch current user to check if we can add friend
                    try {
                        const currentUserResp = await fetch('/auth/current_user');
                        if (currentUserResp.ok) {
                            const currentUser = await currentUserResp.json();

                            // Check if:
                            // 1. Not own profile
                            // 2. Not already friends (friends list contains ID? API returns usernames for friends on public profile, need to check ID from full user array if possible, OR just check usernames since public endpoints return that. Wait, /username/:username returns friends as simple objects or IDs? 
                            // Let's check users.ts: .populate('friends', 'username'). So user.friends is array of objects { _id, username }.
                            // We need to compare IDs.

                            // Actually, public profile 'friends' are populated with { _id, username }. 
                            // currentUser._id vs user._id

                            const isOwnProfile = currentUser._id === user._id;
                            const isAlreadyFriend = user.friends.some(f => f._id === currentUser._id || f === currentUser._id); // Handle both populated and unpopulated just in case

                            if (!isOwnProfile && !isAlreadyFriend) {
                                const addFriendBtn = document.getElementById('addFriendBtn');
                                addFriendBtn.style.display = 'inline-block';

                                console.log("step 1")

                                addFriendBtn.addEventListener('click', async () => {
                                    try {
                                        const req = await fetch(`/api/users/${user._id}/friend-requests`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ requesterId: currentUser._id })
                                        });

                                        if (req.ok) {
                                            alert('Richiesta inviata!');
                                            addFriendBtn.style.display = 'none';
                                        } else {
                                            const err = await req.json();
                                            alert('Errore: ' + err.message);
                                        }
                                    } catch (e) {
                                        console.error(e);
                                        alert('Errore di connessione');
                                    }
                                });
                            }
                        }
                    } catch (e) {
                        console.error('Error fetching current user', e);
                    }

                } else {
                    document.getElementById('username').textContent = 'User not found';
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                document.getElementById('username').textContent = 'Error loading profile';
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>