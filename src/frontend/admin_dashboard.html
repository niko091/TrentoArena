<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container">
        <div class="dashboard-header">
            <h1>Admin Dashboard</h1>
        </div>

        <div class="dashboard-grid">
            <!-- Add Place Card -->
            <section class="dashboard-card">
                <h2>Add New Place</h2>
                <form id="add-place-form">
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="name" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="sport">Sport</label>
                        <select id="sport" name="sport" class="form-control" required>
                            <option value="" disabled selected>Select a sport</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lat">Latitude</label>
                        <input type="number" id="lat" name="lat" step="any" class="form-control" placeholder="46.0..."
                            required>
                    </div>
                    <div class="form-group">
                        <label for="lng">Longitude</label>
                        <input type="number" id="lng" name="lng" step="any" class="form-control" placeholder="11.1..."
                            required>
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">Add Place</button>
                </form>
            </section>

            <!-- Sports Management Card -->
            <section class="dashboard-card">
                <h2>Existing Sports</h2>

                <div style="margin-bottom: 2rem;">
                    <h3>Add New Sport</h3>
                    <form id="add-sport-form" style="display: flex; gap: 0.5rem;">
                        <input type="text" id="sport-name" name="name" class="form-control" placeholder="Sport Name"
                            required>
                        <button type="submit" class="btn btn-primary">Add</button>
                    </form>
                </div>

                <div>
                    <h3>Existing Sports</h3>
                    <ul id="sports-list" class="list-group">
                        <!-- Sports will be populated here -->
                        <li class="list-item" style="justify-content: center; color: #999;">Loading...</li>
                    </ul>
                </div>
            </section>
        </div>

        <section class="dashboard-card">
            <h2>Existing Places</h2>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Sport</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="places-table-body">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // Fetch and display places
        async function fetchPlaces() {
            try {
                const response = await fetch('/api/places');
                if (!response.ok) {
                    throw new Error('Failed to fetch places');
                }
                const places = await response.json();
                const tableBody = document.getElementById('places-table-body');

                tableBody.innerHTML = ''; // Clear existing data

                places.forEach(place => {
                    const row = document.createElement('tr');
                    // Handle populated sport object or potential missing data
                    const sportName = place.sport && place.sport.name ? place.sport.name : 'Unknown';

                    row.innerHTML = `
                        <td>${place.name}</td>
                        <td>${sportName}</td>
                        <td>${place.position.lat}</td>
                        <td>${place.position.lng}</td>
                        <td>
                            <button onclick="deletePlace('${place._id}')" class="btn btn-danger">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading places:', error);
                alert('Error loading places. See console for details.');
            }
        }

        async function deletePlace(id) {
            if (!confirm('Are you sure you want to delete this place?')) {
                return;
            }

            try {
                const response = await fetch(`/api/places/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Place deleted successfully');
                    fetchPlaces(); // Refresh table
                } else {
                    const errorData = await response.json();
                    alert(`Error deleting place: ${errorData.message}`);
                }
            } catch (error) {
                console.error('Error deleting place:', error);
                alert('Error deleting place. See console for details.');
            }
        }


        // Fetch and populate sports dropdown and list
        async function fetchSports() {
            try {
                const response = await fetch('/api/sports');
                const sports = await response.json();

                // Populate Dropdown
                const select = document.getElementById('sport');
                select.innerHTML = '<option value="" disabled selected>Select a sport</option>';

                // Populate List
                const list = document.getElementById('sports-list');
                list.innerHTML = '';

                sports.forEach(sport => {
                    // Dropdown
                    const option = document.createElement('option');
                    option.value = sport._id;
                    option.textContent = sport.name;
                    select.appendChild(option);

                    // List
                    const listItem = document.createElement('li');
                    listItem.textContent = sport.name;
                    listItem.className = 'list-item';
                    list.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error fetching sports:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            fetchPlaces();
            fetchSports();

            const form = document.getElementById('add-place-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = {
                    name: document.getElementById('name').value,
                    sport: document.getElementById('sport').value,
                    position: {
                        lat: parseFloat(document.getElementById('lat').value),
                        lng: parseFloat(document.getElementById('lng').value)
                    }
                };

                try {
                    const response = await fetch('/api/places', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        alert('Place added successfully!');
                        form.reset();
                        fetchPlaces(); // Refresh table
                    } else {
                        const errorData = await response.json();
                        alert(`Error adding place: ${errorData.message}`);
                    }
                } catch (error) {
                    console.error('Error adding place:', error);
                    alert('Error adding place. See console for details.');
                }
            });

            // Add Sport Form Handler
            const sportForm = document.getElementById('add-sport-form');
            sportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('sport-name').value;

                try {
                    const response = await fetch('/api/sports', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });

                    if (response.ok) {
                        alert('Sport added successfully!');
                        sportForm.reset();
                        fetchSports(); // Refresh list and dropdown
                    } else {
                        const data = await response.json();
                        alert(`Error adding sport: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Error adding sport:', error);
                    alert('Error adding sport');
                }
            });
        });
    </script>
</body>

</html>