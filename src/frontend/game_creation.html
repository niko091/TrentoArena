<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrentoArena - GameCreation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="css/style.css">

    <style>
        .navbar-orange {
            background-color: rgb(223, 103, 5);
            padding-top: 15px;
            color: white;
            font-size: 20px;
        }

        .containerInput {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 50px
        }

        .containerTimeInput {
            display: flex;
            justify-content: center;
            gap: 100px;
        }
    </style>
</head>

<body>

    <nav class="navbar  navbar-orange">
        <div class="container-fluid">
            <div class="flex-grow-1 d-flex justify-content-center">
                <h1><b>CREA PARTITA</b></h1>
            </div>
        </div>
    </nav>

    <div class="containerInput">
        <div class="form-group col-md-4">
            <strong for="inputSport">Sport</strong>
            <select id="inputSport" class="form-control">
                <option selected>Choose...</option>
                <option>...</option>
            </select>
        </div>

        <div class="form-group col-md-4">
            <strong for="inputMap">Luogo</strong>
            <select id="inputMap" class="form-control">
                <option selected>Choose...</option>
                <option>...</option>
            </select>
        </div>

        <div class="containerTimeInput">
            <div class="form-group col-md-4">
                <strong for="dateInput">Data</strong>
                <input type="date" class="form-control" id="dateInput">
            </div>

            <div class="form-group col-md-4">
                <strong for="timeInput" class="form-label">Orario</strong>
                <input type="time" class="form-control" id="timeInput">
            </div>
        </div>

        <div class="form-group col-md-4">
            <strong for="inputTipo">Tipo di partita</strong>
            <select id="inputTipo" class="form-control">
                <option selected>Choose...</option>
                <option>...</option>
            </select>
        </div>

        <div class="form-group col-md-4">
            <strong for="inputNote">Note</strong>
            <textarea class="form-control" id="inputNote" rows="3"></textarea>
        </div>

        <div class="form-group col-md-4 mt-4">
            <button type="button" class="btn btn-primary" onclick="createGame()">Create Game</button>
        </div>
    </div>

    <script>
        let allPlaces = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await loadSports();
            await loadPlaces();

            document.getElementById('inputSport').addEventListener('change', filterPlacesBySport);
        });

        async function loadSports() {
            try {
                const response = await fetch('/api/sports');
                if (!response.ok) throw new Error('Failed to fetch sports');
                const sports = await response.json();

                const sportSelect = document.getElementById('inputSport');
                // Keep the first "Choose..." option
                sportSelect.innerHTML = '<option selected>Choose...</option>';

                sports.forEach(sport => {
                    const option = document.createElement('option');
                    option.value = sport._id;
                    option.textContent = sport.name;
                    sportSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading sports:', error);
            }
        }

        async function loadPlaces() {
            try {
                const response = await fetch('/api/places');
                if (!response.ok) throw new Error('Failed to fetch places');
                allPlaces = await response.json();
                renderPlaces(allPlaces);
            } catch (error) {
                console.error('Error loading places:', error);
            }
        }

        function renderPlaces(places) {
            const placeSelect = document.getElementById('inputMap');
            // Keep the first "Choose..." option
            placeSelect.innerHTML = '<option selected>Choose...</option>';

            places.forEach(place => {
                const option = document.createElement('option');
                option.value = place._id;
                option.textContent = place.name;
                placeSelect.appendChild(option);
            });
        }

        function filterPlacesBySport(event) {
            const selectedSportId = event.target.value;

            if (selectedSportId === 'Choose...') {
                renderPlaces(allPlaces);
            } else {
                const filteredPlaces = allPlaces.filter(place =>
                    place.sport && place.sport._id === selectedSportId
                );
                renderPlaces(filteredPlaces);
            }
        }

        async function createGame() {
            const sportId = document.getElementById('inputSport').value;
            const placeId = document.getElementById('inputMap').value;
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeInput').value;
            const note = document.getElementById('inputNote').value;

            if (sportId === 'Choose...' || !sportId) {
                alert('Please select a Sport.');
                return;
            }
            if (placeId === 'Choose...' || !placeId) {
                alert('Please select a Place.');
                return;
            }
            if (!date) {
                alert('Please select a Date.');
                return;
            }
            if (!time) {
                alert('Please select a Time.');
                return;
            }

            const payload = {
                sportId,
                placeId,
                date,
                time,
                note
            };

            try {
                const response = await fetch('/api/games', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Game created successfully!');
                    // Redirect or clear form?
                    window.location.href = '/dashboard.html'; // Or wherever
                } else {
                    const error = await response.json();
                    alert('Error creating game: ' + (error.message || 'Unknown error'));
                }
            } catch (err) {
                console.error('Network error:', err);
                alert('Failed to connect to server.');
            }
        }
    </script>

</body>

</html>